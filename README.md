# C51 循迹小车

## 零代码质量, 仅作存档

---

## AI 总结内容

基于C51单片机的智能循迹小车项目，具备循迹、避障、倒车找线等复杂功能。

## 项目概述

这是一个使用C51单片机开发的智能循迹小车，通过8个红外传感器检测黑色轨迹线，实现自动循迹行驶。项目采用状态机设计，具备完善的错误处理和恢复机制。

## 功能特性

### 核心功能
- **智能循迹**: 使用8个红外传感器精确检测轨迹线
- **自适应速度控制**: 根据转弯角度自动调整速度
- **LED转向指示**: 左右转弯时相应LED灯亮起
- **蜂鸣器提示**: 大转弯时蜂鸣器响起

### 高级功能
- **倒车找线**: 脱线时自动倒车并重新寻找轨迹线
- **超声波避障**: 检测前方障碍物并自动避让
- **数码管显示**: 实时显示传感器状态、距离等信息
- **终点检测**: 自动识别终点并停止

### 状态机设计
- **循迹状态**: 正常循迹行驶
- **避障状态**: 检测到障碍物时的避让流程
- **倒车状态**: 脱线时的恢复流程
- **超声波状态**: 距离测量状态机

## 硬件配置

### 主要组件
- **主控芯片**: C51单片机
- **传感器**: 8个红外传感器 (P1端口)
- **电机驱动**: L298N电机驱动模块
- **显示**: 4位数码管 (P0端口)
- **超声波**: HC-SR04超声波模块
- **指示**: 左右LED指示灯、蜂鸣器

### 引脚分配
```c
// 传感器端口 (8位)
#define Ir P1

// 数码管端口
#define NixieData P0
#define Nixie0 P2_0
#define Nixie1 P2_1
#define Nixie2 P2_2
#define Nixie3 P2_3

// 超声波
#define UltrasonicTrig P2_4
#define UltrasonicEcho P2_5

// LED指示
#define LedRight P2_6
#define LedLeft P2_7

// 电机控制
#define Motor0 P3_0
#define Motor1 P3_1
#define MotorIn1 P3_2
#define MotorIn2 P3_3
#define MotorIn3 P3_4
#define MotorIn4 P3_5

// 蜂鸣器
#define Buzzer P3_6
```

## 代码结构

### 主要文件
- `main.c` - 主程序文件，包含所有核心逻辑
- `timer.h/c` - 定时器相关函数
- `nixie.h/c` - 数码管显示函数
- `key.h/c` - 按键处理函数
- `typedef.h` - 类型定义

### 核心算法

#### 传感器数据处理
```c
// 8个传感器的权重分配
const int8 code SENSOR_VALUE_WEIGHT[8] = { -9, -5, -2, 0, 0, 2, 5, 9 };

// 提取边缘和中间传感器值
#define EXTRACT_SENSOR_VALUE_EDGE(P) ((P >> 4) & 0x0C | P & 0x03)
#define EXTRACT_SENSOR_VALUE_MIDDLE(P) ((P >> 2) & 0x0F)
```

#### 循迹控制
- **基础速度**: 72 (PWM值)
- **转向分级**: 4个级别的转向力度
- **速度自适应**: 根据传感器极值自动减速

#### 状态机
- **ReverseState**: 倒车找线状态机
- **AvoidState**: 避障状态机  
- **SonicState**: 超声波测量状态机

## 运行流程

### 启动流程
1. 系统初始化，等待按键启动
2. 蜂鸣器提示音(1秒)
3. 进入主循环

### 主循环优先级
1. **避障状态** (最高优先级)
2. **倒车找线状态** (脱线时)
3. **正常循迹状态**

### 循迹策略
- 优先处理边缘传感器
- 根据传感器模式分级转向
- 大转弯时启用蜂鸣器
- 自适应速度控制

## 参数配置

### 时间参数
```c
#define DESTINATION_TIME_8MS 11250    // 1.5分钟终点检测
#define MIN_EXTREME_DURATION_8MS 750  // 6秒极值持续时间
#define LOST_LINE_DEBOUNCE_COUNT 64   // 脱线消抖计数
#define FOUND_LINE_DEBOUNCE_COUNT 8   // 找到线消抖计数
```

### 速度参数
```c
#define SPEED_BASE 72                  // 基础速度
#define REVERSE_SPEED 40               // 倒车速度
#define TURN_SPEED 50                  // 转向速度
#define AVOIDANCE_SPEED 60             // 避障速度
```

### 转向参数
```c
#define STEERING_1 8   // 小偏转
#define STEERING_2 12  // 较偏转
#define STEERING_3 16  // 大偏转
#define STEERING_4 24  // 极限偏转
```

## 显示信息

数码管显示内容根据状态变化：
- **正常状态**: 显示超声波距离
- **避障状态**: 显示避障状态机状态
- **倒车状态**: 显示倒车模式和覆盖模式

## 编译和运行

### 开发环境
- Keil uVision IDE
- C51编译器

### 编译步骤
1. 打开 `Project.uvproj` 项目文件
2. 编译项目
3. 下载到C51单片机

### 启动方式
- 任意按键按下后启动小车
- 蜂鸣器响1秒表示启动完成

## 项目特点

### 技术亮点
1. **多状态机设计**: 清晰的逻辑分离
2. **消抖处理**: 稳定的传感器数据处理
3. **自适应控制**: 智能的速度和转向调整
4. **错误恢复**: 完善的脱线恢复机制
5. **实时显示**: 丰富的状态信息显示

### 性能优化
- 使用定时器中断实现精确的时间控制
- PWM电机控制实现平滑的速度调节
- 状态机设计减少CPU占用

## 注意事项

- 确保传感器安装位置准确
- 调整参数以适应不同的赛道条件
- 注意电池电量，影响电机性能
- 超声波模块需要清晰的检测环境

## 文件说明

- `main.c` - 主程序，包含所有核心逻辑
- `_histmain/` - 历史版本备份
- `Listings/` - 编译列表文件
- `Objects/` - 编译输出文件

## 许可证

详见 LICENSE 文件

---

